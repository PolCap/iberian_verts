# --------------------------------------------------------------------------------------- #
# - FILE NAME:   Data Check.R         
# - DATE: 25/02/2022
# - DESCRIPTION: Code to correct duplicate measures and other errors in the dataset.  
# - AUTHORS: Pol Capdevila (pcapdevila@gmail.com)     
# --------------------------------------------------------------------------------------- #

rm(list=ls(all=TRUE)) #remove everything

library(tidyverse)
library(data.table)
library(dplyr)
library(goeveg)
library(RcppRoll)
library(tidyr)

# Set working directory

path <- gsub("Code", "", dirname(rstudioapi::getActiveDocumentContext()$path))

CodePath <- paste0(path,"Code")
DataPath <-  paste0(path,"Data")
ResultPath <-  paste0(path, "Results") 

# Read in data

lpi_data <- read.csv(paste0(DataPath,"/LPDIberia.csv"))
iberian_data <- read.csv2(paste0(DataPath,"/data_all.csv"),
                          dec = ",", encoding = "UTF-8")
iberian_metadata <- read.csv2(paste0(DataPath,"/metadata.csv"))

# Join the iberian data with the metadata

iberian_metadata<- iberian_metadata %>%
  filter(Series_ID!="gris3.7",
         Series_ID!="") 

iberian_pops <- iberian_data %>%
  filter(Series_ID!="gris13.6",
         Series_ID!="") %>% 
  left_join(iberian_metadata) %>%
  mutate(Year=as.numeric(Year),
         Count=as.numeric(Abundance),
         ID=paste(StudyID, Series_ID))

# Data cleaning

lpi_data <- lpi_data %>% 
  mutate(Year=as.numeric(Year), # Make count and year numeric
         Count=as.numeric(Count),
         # Change species names
         Species= gsub("_", " ", lpi_data$Binomial))

# Estimate population change

lpi_data <- lpi_data %>%
  filter(!is.na(Count)) %>% 
  # Create a factor for year
  mutate(year=Year,
         Dataset="LPD", 
         ID=paste(Dataset, ID)) %>% 
  rename(Protected=Protected_status,
         Author = Reference) %>% 
  dplyr::select(ID, Species, Year, Author,
                Location, Latitude, Longitude, 
                Data_source_type) 
  
# Now for our data

iberian_pops <- iberian_pops %>%
  filter(!is.na(Count)) %>% 
  # Create a factor for year
  mutate(year=Year,
         Dataset="Vertebichos",
         ID=as.factor(paste(Dataset, ID))) %>% 
  dplyr::select(ID, Species, Year, Author,
                Location, Latitude, Longitude, 
                Data_source_type,) 

# Join the two datasets 

total_data <- rbind(lpi_data, iberian_pops)

# Check for replicates

dobles <- total_data %>%  
  distinct(ID, .keep_all = T) %>% 
  group_by(Species) %>% 
  filter(n()>1)

# Save them 

setwd(ResultPath)
#write.csv(dobles,file = "Duplicates.csv")

# Remove these from the database

final_data <- total_data %>%  
  filter(ID!="Vertebichos CV9 CV9.1",
         ID!="Vertebichos CV9 CV9.10",
         ID!="Vertebichos CV9 CV9.11",
         ID!="Vertebichos CV9 CV9.12",
         ID!="Vertebichos CV9 CV9.13",
         ID!="Vertebichos CV9 CV9.14",
         ID!="Vertebichos CV9 CV9.15",
         ID!="Vertebichos CV9 CV9.16",
         ID!="Vertebichos CV9 CV9.17",
         ID!="Vertebichos CV9 CV9.18",
         ID!="Vertebichos CV9 CV9.19",
         ID!="Vertebichos CV9 CV9.2",
         ID!="Vertebichos CV9 CV9.20",
         ID!="Vertebichos CV9 CV9.21",
         ID!="Vertebichos CV9 CV9.22",
         ID!="Vertebichos CV9 CV9.23",
         ID!="Vertebichos CV9 CV9.24",
         ID!="Vertebichos CV9 CV9.25",
         ID!="Vertebichos CV9 CV9.26",
         ID!="Vertebichos CV9 CV9.27",
         ID!="Vertebichos CV9 CV9.28",
         ID!="Vertebichos CV9 CV9.29",
         ID!="Vertebichos CV9 CV9.3",
         ID!="Vertebichos CV9 CV9.30",
         ID!="Vertebichos CV9 CV9.31",
         ID!="Vertebichos CV9 CV9.32",
         ID!="Vertebichos CV9 CV9.33",
         ID!="Vertebichos CV9 CV9.34",
         ID!="Vertebichos CV9 CV9.4",
         ID!="Vertebichos CV9 CV9.5",
         ID!="Vertebichos CV9 CV9.6",
         ID!="Vertebichos 415 415_01",
         ID!="Vertebichos 415 415_02",
         ID!="Vertebichos 597 597.1",
         ID!="Vertebichos 597 597.2",
         ID!="Vertebichos 597 597.3",
         ID!="Vertebichos 597 597.4",
         ID!="Vertebichos 215 215.1",
         ID!="Vertebichos 407 407_01",
         ID!="Vertebichos 407 407_02",
         ID!="Vertebichos Mur1 Mur1_025",
         ID!="Vertebichos Mur1 Mur1_014",
         ID!="Vertebichos Mur1 Mur1_089",
         ID!="LPD 6924",
         ID!="LPD 23237",
         ID!="Vertebichos 302 302.6",
         ID!="Vertebichos 302 302.2",
         ID!="LPD 23163",
         ID!="LPD 23215",
         ID!="LPD 1231",
         ID!="LPD 6550",
         ID!="LPD 17417",
         ID!="LPD 6641",
         ID!="LPD 23163",
         ID!="LPD 1237",
         ID!="LPD 1231",
         ID!="Vertebichos 14 14.9",
         ID!="Vertebichos gris15 gris15.2",
         ID!="Vertebichos gris14 gris14.12",
         ID!="Vertebichos 302 302.3",
         ID!="LPD 6622",
         ID!="Vertebichos gris14 gris14.31",
         ID!="Vertebichos gris14 gris14.4",
         ID!="LPD 6839",
         ID!="LPD 6621",
         ID!="Vertebichos 302 302.4",
         ID!="Vertebichos gris14 gris14.11",
         ID!="Vertebichos 615 615.14",
         ID!="Vertebichos 615 615.32",
         ID!="Vertebichos 615 615.2",
         ID!="Vertebichos 615 615.20",
         ID!="Vertebichos 636 636_1",
         ID!="LPD 7201",
         ID!="Vertebichos 460 460_03",
         ID!="LPD 23224",
         ID!="LPD 6932",
         ID!="Vertebichos 615 615.21",
         ID!="Vertebichos 615 615.3",
         ID!="Vertebichos 460 460_07",
         ID!="Vertebichos 566 566.2",
         ID!="Vertebichos 566 566.1",
         ID!="Vertebichos CV2 CV2.1",
         ID!="Vertebichos CV2 CV2.10",
         ID!="Vertebichos CV2 CV2.11",
         ID!="Vertebichos CV2 CV2.12",
         ID!="Vertebichos CV2 CV2.13",
         ID!="Vertebichos CV2 CV2.14",
         ID!="Vertebichos CV2 CV2.15",
         ID!="Vertebichos CV2 CV2.16",
         ID!="Vertebichos CV2 CV2.17",
         ID!="Vertebichos CV2 CV2.18",
         ID!="Vertebichos CV2 CV2.19",
         ID!="Vertebichos CV2 CV2.2",
         ID!="Vertebichos CV2 CV2.20",
         ID!="Vertebichos CV2 CV2.21",
         ID!="Vertebichos CV2 CV2.22",
         ID!="Vertebichos CV2 CV2.23",
         ID!="Vertebichos CV2 CV2.24",
         ID!="Vertebichos CV2 CV2.25",
         ID!="Vertebichos CV2 CV2.26",
         ID!="Vertebichos CV2 CV2.27",
         ID!="Vertebichos CV2 CV2.28",
         ID!="Vertebichos CV2 CV2.29",
         ID!="Vertebichos CV2 CV2.3",
         ID!="Vertebichos CV2 CV2.30",
         ID!="Vertebichos CV2 CV2.31",
         ID!="Vertebichos CV2 CV2.32",
         ID!="Vertebichos CV2 CV2.33",
         ID!="Vertebichos CV2 CV2.34",
         ID!="Vertebichos CV2 CV2.4",
         ID!="Vertebichos CV2 CV2.40",
         ID!="Vertebichos CV2 CV2.5",
         ID!="Vertebichos CV2 CV2.6",
         ID!="Vertebichos CV2 CV2.7",
         ID!="Vertebichos CV2 CV2.8",
         ID!="Vertebichos CV2 CV2.9",
         ID!="Vertebichos 615 615.23",
         ID!="Vertebichos 615 615.5",
         ID!="Vertebichos CV1 CV1.1",
         ID!="Vertebichos CV1 CV1.10",
         ID!="Vertebichos CV1 CV1.11",
         ID!="Vertebichos CV1 CV1.12",
         ID!="Vertebichos CV1 CV1.13",
         ID!="Vertebichos CV1 CV1.14",
         ID!="Vertebichos CV1 CV1.15",
         ID!="Vertebichos CV1 CV1.16",
         ID!="Vertebichos CV1 CV1.17",
         ID!="Vertebichos CV1 CV1.18",
         ID!="Vertebichos CV1 CV1.19",
         ID!="Vertebichos CV1 CV1.2",
         ID!="Vertebichos CV1 CV1.20",
         ID!="Vertebichos CV1 CV1.21",
         ID!="Vertebichos CV1 CV1.22",
         ID!="Vertebichos CV1 CV1.23",
         ID!="Vertebichos CV1 CV1.24",
         ID!="Vertebichos CV1 CV1.25",
         ID!="Vertebichos CV1 CV1.26",
         ID!="Vertebichos CV1 CV1.27",
         ID!="Vertebichos CV1 CV1.28",
         ID!="Vertebichos CV1 CV1.29",
         ID!="Vertebichos CV1 CV1.3",
         ID!="Vertebichos CV1 CV1.30",
         ID!="Vertebichos CV1 CV1.31",
         ID!="Vertebichos CV1 CV1.32",
         ID!="Vertebichos CV1 CV1.33",
         ID!="Vertebichos CV1 CV1.34",
         ID!="Vertebichos CV1 CV1.4",
         ID!="Vertebichos CV1 CV1.40",
         ID!="Vertebichos CV1 CV1.5",
         ID!="Vertebichos CV1 CV1.6",
         ID!="Vertebichos CV1 CV1.7",
         ID!="Vertebichos CV1 CV1.8",
         ID!="Vertebichos CV1 CV1.9",
         ID!="Vertebichos CV3 CV3.1",
         ID!="Vertebichos CV3 CV3.10",
         ID!="Vertebichos CV3 CV3.11",
         ID!="Vertebichos CV3 CV3.12",
         ID!="Vertebichos CV3 CV3.13",
         ID!="Vertebichos CV3 CV3.14",
         ID!="Vertebichos CV3 CV3.15",
         ID!="Vertebichos CV3 CV3.16",
         ID!="Vertebichos CV3 CV3.17",
         ID!="Vertebichos CV3 CV3.18",
         ID!="Vertebichos CV3 CV3.19",
         ID!="Vertebichos CV3 CV3.2",
         ID!="Vertebichos CV3 CV3.20",
         ID!="Vertebichos CV3 CV3.21",
         ID!="Vertebichos CV3 CV3.22",
         ID!="Vertebichos CV3 CV3.23",
         ID!="Vertebichos CV3 CV3.24",
         ID!="Vertebichos CV3 CV3.25",
         ID!="Vertebichos CV3 CV3.26",
         ID!="Vertebichos CV3 CV3.27",
         ID!="Vertebichos CV3 CV3.28",
         ID!="Vertebichos CV3 CV3.29",
         ID!="Vertebichos CV3 CV3.3",
         ID!="Vertebichos CV3 CV3.30",
         ID!="Vertebichos CV3 CV3.31",
         ID!="Vertebichos CV3 CV3.32",
         ID!="Vertebichos CV3 CV3.33",
         ID!="Vertebichos CV3 CV3.34",
         ID!="Vertebichos CV3 CV3.4",
         ID!="Vertebichos CV3 CV3.40",
         ID!="Vertebichos CV3 CV3.5",
         ID!="Vertebichos CV3 CV3.6",
         ID!="Vertebichos CV3 CV3.7",
         ID!="Vertebichos CV3 CV3.8",
         ID!="Vertebichos CV3 CV3.9",
         ID!="Vertebichos 16 16.1",
         ID!="Vertebichos gris5 gris5.1",
         ID!= "Vertebichos 378 378.1", 
         ID!="Vertebichos 482 482.1",
         ID!="LPD 7204",
         ID!="Vertebichos gris14 gris14.30",
         ID!="Vertebichos 487 487_12",
         ID!="Vertebichos 615 615.26",
         ID!="Vertebichos 615 615.8",
         ID!="LPD 7223",
         ID!="Vertebichos 292 292.1",
         ID!="Vertebichos gris14 gris14.28",
         ID!="Vertebichos 487 487_13",
         ID!="Vertebichos 487 487_18",
         ID!="LPD 7227",
         ID!="LPD 23214",
         ID!="Vertebichos 487 487_19",
         ID!="Vertebichos 888 888_12",
         ID!="LPD 22993",
         ID!="Vertebichos 368 368.3",
         ID!="Vertebichos 368 368.4",
         ID!="Vertebichos 487 487_20",
         ID!="Vertebichos CV6 CV6.1",
         ID!="Vertebichos CV6 CV6.10",
         ID!="Vertebichos CV6 CV6.11",
         ID!="Vertebichos CV6 CV6.12",
         ID!="Vertebichos CV6 CV6.13",
         ID!="Vertebichos CV6 CV6.14",
         ID!="Vertebichos CV6 CV6.15",
         ID!="Vertebichos CV6 CV6.16",
         ID!="Vertebichos CV6 CV6.17",
         ID!="Vertebichos CV6 CV6.18",
         ID!="Vertebichos CV6 CV6.19",
         ID!="Vertebichos CV6 CV6.2",
         ID!="Vertebichos CV6 CV6.20",
         ID!="Vertebichos CV6 CV6.21",
         ID!="Vertebichos CV6 CV6.22",
         ID!="Vertebichos CV6 CV6.23",
         ID!="Vertebichos CV6 CV6.24",
         ID!="Vertebichos CV6 CV6.25",
         ID!="Vertebichos CV6 CV6.26",
         ID!="Vertebichos CV6 CV6.27",
         ID!="Vertebichos CV6 CV6.28",
         ID!="Vertebichos CV6 CV6.29",
         ID!="Vertebichos CV6 CV6.3",
         ID!="Vertebichos CV6 CV6.30",
         ID!="Vertebichos CV6 CV6.31",
         ID!="Vertebichos CV6 CV6.32",
         ID!="Vertebichos CV6 CV6.33",
         ID!="Vertebichos CV6 CV6.34",
         ID!="Vertebichos CV6 CV6.4",
         ID!="Vertebichos CV6 CV6.40",
         ID!="Vertebichos CV6 CV6.5",
         ID!="Vertebichos CV6 CV6.6",
         ID!="Vertebichos CV6 CV6.7",
         ID!="Vertebichos CV6 CV6.8",
         ID!="Vertebichos CV6 CV6.9",
         ID!="Vertebichos CV7 CV7.1",
         ID!="Vertebichos CV7 CV7.10",
         ID!="Vertebichos CV7 CV7.11",
         ID!="Vertebichos CV7 CV7.12",
         ID!="Vertebichos CV7 CV7.13",
         ID!="Vertebichos CV7 CV7.14",
         ID!="Vertebichos CV7 CV7.15",
         ID!="Vertebichos CV7 CV7.16",
         ID!="Vertebichos CV7 CV7.17",
         ID!="Vertebichos CV7 CV7.18",
         ID!="Vertebichos CV7 CV7.19",
         ID!="Vertebichos CV7 CV7.2",
         ID!="Vertebichos CV7 CV7.20",
         ID!="Vertebichos CV7 CV7.21",
         ID!="Vertebichos CV7 CV7.22",
         ID!="Vertebichos CV7 CV7.23",
         ID!="Vertebichos CV7 CV7.24",
         ID!="Vertebichos CV7 CV7.25",
         ID!="Vertebichos CV7 CV7.26",
         ID!="Vertebichos CV7 CV7.27",
         ID!="Vertebichos CV7 CV7.28",
         ID!="Vertebichos CV7 CV7.29",
         ID!="Vertebichos CV7 CV7.3",
         ID!="Vertebichos CV7 CV7.30",
         ID!="Vertebichos CV7 CV7.31",
         ID!="Vertebichos CV7 CV7.32",
         ID!="Vertebichos CV7 CV7.33",
         ID!="Vertebichos CV7 CV7.34",
         ID!="Vertebichos CV7 CV7.4",
         ID!="Vertebichos CV7 CV7.40",
         ID!="Vertebichos CV7 CV7.5",
         ID!="Vertebichos CV7 CV7.6",
         ID!="Vertebichos CV7 CV7.7",
         ID!="Vertebichos CV7 CV7.8",
         ID!="Vertebichos CV7 CV7.9",
         ID!="Vertebichos CV8 CV8.1",
         ID!="Vertebichos CV8 CV8.10",
         ID!="Vertebichos CV8 CV8.11",
         ID!="Vertebichos CV8 CV8.12",
         ID!="Vertebichos CV8 CV8.13",
         ID!="Vertebichos CV8 CV8.14",
         ID!="Vertebichos CV8 CV8.15",
         ID!="Vertebichos CV8 CV8.16",
         ID!="Vertebichos CV8 CV8.17",
         ID!="Vertebichos CV8 CV8.18",
         ID!="Vertebichos CV8 CV8.19",
         ID!="Vertebichos CV8 CV8.2",
         ID!="Vertebichos CV8 CV8.20",
         ID!="Vertebichos CV8 CV8.21",
         ID!="Vertebichos CV8 CV8.22",
         ID!="Vertebichos CV8 CV8.23",
         ID!="Vertebichos CV8 CV8.24",
         ID!="Vertebichos CV8 CV8.25",
         ID!="Vertebichos CV8 CV8.26",
         ID!="Vertebichos CV8 CV8.27",
         ID!="Vertebichos CV8 CV8.28",
         ID!="Vertebichos CV8 CV8.29",
         ID!="Vertebichos CV8 CV8.3",
         ID!="Vertebichos CV8 CV8.30",
         ID!="Vertebichos CV8 CV8.31",
         ID!="Vertebichos CV8 CV8.32",
         ID!="Vertebichos CV8 CV8.33",
         ID!="Vertebichos CV8 CV8.34",
         ID!="Vertebichos CV8 CV8.4",
         ID!="Vertebichos CV8 CV8.40",
         ID!="Vertebichos CV8 CV8.5",
         ID!="Vertebichos CV8 CV8.6",
         ID!="Vertebichos CV8 CV8.7",
         ID!="Vertebichos CV8 CV8.8",
         ID!="Vertebichos CV8 CV8.9",
         ID!="Vertebichos CV8 CV8.9",
         ID!="Vertebichos 406 406_01",
         ID!="Vertebichos gris17 gris17.5",
         ID!="LPD 6779",
         ID!="LPD 6594",
         ID!="Vertebichos 615 615.12",
         ID!="Vertebichos 615 615.30",
         ID!="LPD 6778",
         ID!="Vertebichos 615 615.11",
         ID!="Vertebichos 615 615.29",
         ID!="LPD 6919", 
         ID!="LPD 6915", 
         ID!="LPD 6633",
         ID!="Vertebichos 181 181.2", 
         ID!="LPD 6943",
         ID!="LPD 22995",
         ID!="Vertebichos 615 615.15",
         ID!="Vertebichos 615 615.33",
         ID!="LPD 6773",
         ID!="LPD 6774",
         ID!="LPD 19497",
         ID!="Vertebichos 186 186.1",
         ID!="LPD 627", 
         ID!="Vertebichos 460 60_01",
         ID!="Vertebichos gris4 gris4.3",
         ID!="Vertebichos Mur1 Mur1_022",
         ID!="Vertebichos 34 34_1", 
         ID!="Vertebichos 487 487_15",
         ID!="Vertebichos 487 487_13",
         ID!="Vertebichos 634 634.37",
         ID!="Vertebichos 615 615.18",
         ID!="Vertebichos 615 615.36", 
         ID!="Vertebichos gris14 gris14.10",
         ID!="Vertebichos gris14 gris14.8",
         ID!="Vertebichos gris6 gris6.1",
         ID!="Vertebichos gris14 gris14.22",
         ID!="Vertebichos gris16 gris16.1",
         ID!="Vertebichos 460 460_06",
         ID!="Vertebichos gris14 gris14.32",
         ID!="Vertebichos 460 460_05",
         ID!="Vertebichos 194 194.2",
         ID!="Vertebichos 23 23.129",
         ID!="Vertebichos 23 23.130",
         ID!="Vertebichos 23 23.131",
         ID!="Vertebichos 23 23.132",
         ID!="Vertebichos 28 28.30",
         ID!="Vertebichos 28 28.22",
         ID!="Vertebichos 287 287.1",
         ID!="Vertebichos 356 356.1", 
         ID!="Vertebichos 177 177.1",
         ID!="Vertebichos 23 23.105",
         ID!="Vertebichos 23 23.106",
         ID!="Vertebichos 23 23.107",
         ID!="Vertebichos 23 23.108",
         ID!="Vertebichos 51 51.1",
         ID!="Vertebichos gris8 gris8.2",
         ID!="Vertebichos gris14 gris14.21",
         ID!="LPD 1197", 
         ID!="LPD 6637",
         ID!="LPD 6632",
         ID!="Vertebichos 487 487_7",
         ID!="Vertebichos 607 607.1",
         ID!="LPD 7167", 
         ID!="Vertebichos 487 487_16",
         ID!="Vertebichos 302 302.1", 
         ID!="Vertebichos Mur1 Mur1_023",
         ID!="Vertebichos 487 487_17",
         ID!="Vertebichos 39 39.2",
         ID!="Vertebichos 39 39.3",
         ID!="Vertebichos 39 39.4", 
         ID!="Vertebichos 189 189.1",
         ID!="Vertebichos 189 189.2",
         ID!="Vertebichos 189 189.3",
         ID!="Vertebichos gris25 gris25.1",
         ID!="Vertebichos gris25 gris25.2",
         ID!="Vertebichos 460 460_04",
         ID!="Vertebichos 384 384.4")


# Save the data

setwd(DataPath)
write.csv(final_data, "data_clean.csv")
